<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

    <title>Reality Whises</title>

    <!-- Required Stylesheets -->
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.css" />

    <!-- Required scripts -->
    <script src="//cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.min.js"></script>
    <script src="//unpkg.com/babel-polyfill@latest/dist/polyfill.min.js"></script>
    <script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.js"></script>
</head>

<body>
    <!-- Our application root element -->
    <div id="app">
        <b-container>
            <b-jumbotron header="Reality Wishes" lead="Make your wishes come true">
                <p>Para publicar un deseo:</p>
                <b-btn variant="danger" href="./Issuing/indexIssuing.html">¡ Pedir deseos !</b-btn>
                <p></p>
                <p>Para contribuir a un deseo:</p>
                <b-btn variant="danger" href="./Donor/indexDonor.html">¡ Subvencionar deseos !</b-btn>
            </b-jumbotron>
            <hr>
            <b-btn variant="danger" href="./Issuing/createIssuing.html">Registrarse para pedir deseos</b-btn>
            <b-btn variant="danger" href="./Donor/createDonor.html">Registrarse para subvencionar deseos</b-btn>
        </b-container>

    </div>

    <!-- Start running your app -->
    <script>
        window.app = new Vue({
            el: '#app',
            data: {
                name: '', //nombre de usuario (no se usa)
                query: '', //búsqueda
                blogId: '', //blog activado
                issuings: [],
                donors: [],
                wishes: [],
                transactions: [],
                post: '', //nuevo post
            },
            computed: {
                showAlert() {
                    return this.name.length > 2 ? true : false
                }
            },
            methods: {
                searchWish() {
                    var self = this
                    var gql = `query{searchWish(name:"${this.query}"){name description price}}`

                    fetch('/graphql?query=' + encodeURIComponent(gql))
                    .then(function(r) {
                        return r.json()
                    })
                    .then(function (json){
                        self.wishes = json.data.searchWish
                    })
                    .catch(function(error) {
                        console.log(error)
                    })
                },

                searchBlogs() {
                    var self = this
                    var gQL = `query{searchBlog(q:"${this.query}"){title creator{name}}}`

                    fetch('/graphql?query=' + encodeURIComponent(gQL))
                        .then(function(r) {
                            return r.json()
                        })
                        .then(function(json) {
                            self.blogs = json.data.searchBlog
                        })
                        .catch(function(error) {
                            console.log(error)
                        })
                },
                getPosts(blogId) {
                    var self = this

                    this.blogId = blogId

                    var gQL = `query{posts(blogId:"${this.blogId}"){title content author{name}}}`
                    console.log(gQL)
                    fetch('/graphql?query=' + encodeURIComponent(gQL))
                        .then(function(r) {
                            return r.json()
                        })
                        .then(function(json) {
                            self.posts = json.data.posts
                        })
                        .catch(function(error) {
                            console.log(error)
                        })
                },
                addPost() {
                    var self = this

                    if (this.post.trim().length == 0) return false

                    this.postId++

                        var gQL = `mutation{addPost(blogId:"${this.blogId}", 
                                        title: "Prueba ${this.name} ${this.postId}", 
                                        content: "${this.post}", 
                                        authorId: "${this.name}")
                                {title}}`

                    console.log(gQL)
                    fetch('/graphql', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                query: gQL
                            })
                        })
                        .then(function(r) {
                            return r.json()
                        })
                        .then(function(json) {
                            console.log(json)
                        })
                        .catch(function(error) {
                            console.log(error)
                        })
                },
                addIssuing() {
                    var self = this
                    var gql = `mutation{addIssuing(name: "${this.name}", surname: "${this.surname}", email: "${this.email}", passwd: "${this.passwd}"){name email}}`
                    console.log(gql)
                    fetch('/graphql', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'appliaction/json'
                        },
                        body: JSON.stringify({
                            query: gql
                        })
                    })
                    .then(function (r) {
                        return r.json()
                    })
                    .then(function (json) {
                        console.log(json)
                    })
                    .catch(function (error) {
                        console.log(error)
                    })
                },
                createUser() {
                    //TO BE COMPLETED
                    var self = this
                    var gQL = `mutation{addUser(name: "${this.name}"){name}}`
                    console.log(gQL)
                    fetch('/graphql', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                query: gQL
                            })
                        })
                        .then(function(r) {
                            return r.json()
                        })
                        .then(function(json) {
                            console.log(json)
                        })
                        .catch(function(error) {
                            console.log(error)
                        })
                },
            },
            mounted() {
                var self = this
                var ES = new EventSource('/news') //ruta API con notificaciones

                console.log('Creando listener de eventos de servidor...')

                ES.addEventListener('new-post', function(event) {
                    var data = JSON.parse(JSON.parse(event.data))
                        //bytes to string -> string to json
                    if (data.blog.title == self.blogId)
                        self.posts.push(data)
                }, false)
                ES.addEventListener('new-user', function(event) {
                    var data = JSON.parse(JSON.parse(event.data))
                    self.users.push(data)
                }, false)
            }
        })
    </script>
</body>

</html>
