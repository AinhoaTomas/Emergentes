<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

    <title>Reality Whises</title>

    <!-- Required Stylesheets -->
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.css" />

    <!-- Required scripts -->
    <script src="//cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.min.js"></script>
    <script src="//unpkg.com/babel-polyfill@latest/dist/polyfill.min.js"></script>
    <script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.js"></script>
</head>

<body>
<!-- Our application root element -->
<div id="vue-template">
    <h3>Inicio de sesión</h3>
    <b-form-group horizontal :label-cols="4" label="Email:">
        <b-form-input v-model.trim="email"></b-form-input>
    </b-form-group>

    <b-form-group horizontal :label-cols="4" label="Contraseña:">
        <b-form-input type="passwd" v-model.trim="passwd"></b-form-input>
    </b-form-group>
    <hr>
    <b-button class="btn btn-dark btn-lg btn-block" @click="sesion">Acceder</b-button>

    <b-table responsive :items="issuingId">
        id: {{issuingId}}
    </b-table>

    <div v-if="!isVisible">
        <h3>Mis deseos</h3>
        <b-button @click="getWishes(issuingId)" class="btn btn-dark btn-lg btn-block">Ver mis deseos</b-button>
        <b-table responsive :items="wishes">
            <p v-for="wish in wishes">
                {{wish.name}} with description: {{wish.description}} with price: {{wish.price}}
            </p>
        </b-table>

        <h3>Pedir deseo</h3>

        <b-form-group horizontal :label-cols="4" label="Nombre del deseo:">
            <b-form-input v-model.trim="name"></b-form-input>
        </b-form-group>

        <b-form-group horizontal :label-cols="4" label="Breve descripción:">
            <b-form-input v-model.trim="description"></b-form-input>
        </b-form-group>

        <b-form-group horizontal :label-cols="4" label="Precio:">
            <b-form-input v-model.trim="price"></b-form-input>
        </b-form-group>

        <hr>
        <b-button @click="addWish" class="btn btn-dark btn-lg btn-block">Publicar deseo</b-button>
    </div>


</div>



<!-- Start running your app -->
<script>
    var app2 = new Vue({
        el: '#vue-template',
        data: {
            email: '',
            passwd: '',
            name: '',
            description: '',
            price: '',
            issuingId: '',
            wishes: [],
            isVisible: false,
        },
        computed: {
            showAlert() {
                return this.isVisible
            }
        },
        methods: {
            sesion() {
                var self = this
                var gql = `query{searchIssuing(email: "${this.email}", passwd: "${this.passwd}"){name id}}`
                fetch('/graphql?query=' + encodeURIComponent(gql))
                    .then(function(r) {
                        return r.json()
                    })
                    .then(function(json) {
                        self.issuingId = json.data.searchIssuing.id
                        console.log(self.issuingId)
                    })
                    .catch(function(error) {
                        console.log(error)
                    })
            },
            addWish() {
                var self = this
                var gql = `mutation{addWish(name: "${this.name}", description: "${this.description}", price: ${this.price}, issuingId: ${this.issuingId}){name price}}`
                fetch('/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: gql
                    })
                })
                    .then(function(r) {
                        return r.json()
                    })
                    .then(function(json) {
                        console.log(json)
                    })
                    .catch(function(error) {
                        console.log(error)
                    })
            },
            getWishes(issuingId) {
                var self = this
                var gQL = `query{wishesIssuing(issuingId: ${issuingId}){name}}`
                fetch('/graphql?query=' + encodeURIComponent(gQL))
                    .then(function(r) {
                        return r.json()
                    })
                    .then(function(json) {
                        self.wishes = json.data.wishes
                        console.log(self.wishes)
                    })
                    .catch(function(error) {
                        console.log(error)
                    })
            },
        },
        mounted() {
            var self = this
            var ES = new EventSource('/news') //ruta API con notificaciones

            console.log('Creando listener de eventos de servidor...')

            ES.addEventListener('new-wish', function(event) {
                var data = JSON.parse(JSON.parse(event.data))
                //bytes to string -> string to json
                self.wishes.push(data)
            }, false)
        }
    })
</script>
</body>

</html>
