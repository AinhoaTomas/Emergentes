<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

    <title>Reality Whises</title>

    <!-- Required Stylesheets -->
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.css" />

    <!-- Required scripts -->
    <script src="//cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.min.js"></script>
    <script src="//unpkg.com/babel-polyfill@latest/dist/polyfill.min.js"></script>
    <script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.js"></script>
</head>

<body>
<!-- Our application root element -->
<div id="vue-template">
    <h3>Inicio de sesión</h3>
    <b-form-group horizontal :label-cols="4" label="Email:">
        <b-form-input v-model.trim="email"></b-form-input>
    </b-form-group>

    <b-form-group horizontal :label-cols="4" label="Contraseña:">
        <b-form-input type="passwd" v-model.trim="passwd"></b-form-input>
    </b-form-group>
    <hr>
    <b-button class="btn btn-dark btn-lg btn-block" @click="sesion">Acceder</b-button>
    <b-button class="btn btn-dark btn-lg btn-block" href="../index.html">Atrás</b-button>

    <b-table responsive :items="donorId">
        id: {{donorId}}
    </b-table>

    <b-form-group v-if="isVisible" horizontal :label-cols="4" label="Buscador de deseos">
        <b-form-input v-model.trim="query" placeholder="... por ejemplo pizza" @keyup.enter="searchWish">
        </b-form-input>
    </b-form-group>
    <div v-if="wishes.length>0">
        <b-card>
            <ul>
                <p v-for="wish in wishes">
                    <b-button @click="transaction(wish.id, wish.issuing.id)">{{wish.name}}</b-button> by {{wish.issuing.name}}
                </p>
            </ul>
        </b-card>
    </div>

    <b-form-group v-if="isTransaction" horizontal :label-cols="4" label="Subencionar deseo">
        <b-form-input v-model.trim="cant" placeholder="... por ejemplo 15" @keyup.enter="addTransaction">
        </b-form-input>
    </b-form-group>

</div>



<!-- Start running your app -->
<script>
    var app2 = new Vue({
        el: '#vue-template',
        data: {
            email: '',
            passwd: '',
            query: '',
            name: '',
            cant: '',
            donorId: '',
            wishId: '',
            issuingId: '',
            wishes: [],
            wishesNew: [],
            transactions: [],
            isVisible: false,
            isTransaction: false,
        },
        computed: {
            showAlert() {
                return this.isVisible
            }
        },
        methods: {
            sesion() {
                var self = this
                var gql = `query{searchDonor(email: "${this.email}", passwd: "${this.passwd}"){name id}}`
                fetch('/graphql?query=' + encodeURIComponent(gql))
                    .then(function(r) {
                        return r.json()
                    })
                    .then(function(json) {
                        self.donorId = json.data.searchDonor.id
                        self.isVisible = true
                        console.log(self.donorId)
                    })
                    .catch(function(error) {
                        console.log(error)
                    })
            },
            searchWish() {
                var self = this
                var gql = `query{searchWish(name: "${this.query}"){name id description issuing{id name}}}`
                fetch('/graphql?query=' + encodeURIComponent(gql))
                    .then(function(r) {
                        return r.json()
                    })
                    .then(function(json) {
                        console.log(json)
                        self.wishes = json.data.searchWish
                    })
                    .catch(function(error) {
                        console.log(error)
                    })
            },
            transaction(wishId, issuingId) {
                this.isTransaction = true
                this.wishId = wishId
                this.issuingId = issuingId
            },
            addTransaction() {
                var self = this
                var gql = `mutation{addTransaction(wishId: ${this.wishId}, issuingId: ${this.issuingId}, donorId: ${this.donorId}, cant: ${this.cant}){wish{name} issuing{name} cant}}`
                fetch('/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: gql
                    })
                })
                    .then(function(r) {
                        return r.json()
                    })
                    .then(function(json) {
                        console.log(json)
                    })
                    .catch(function(error) {
                        console.log(error)
                    })
            },

        },
        mounted() {
            var self = this
            var ES = new EventSource('/news') //ruta API con notificaciones

            console.log('Creando listener de eventos de servidor...')

            ES.addEventListener('new-wish', function(event) {
                var data = JSON.parse(JSON.parse(event.data))
                //bytes to string -> string to json
                self.wishesNew.push(data)
            }, false)
            ES.addEventListener('new-transaction', function(event) {
                var data = JSON.parse(JSON.parse(event.data))
                //bytes to string -> string to json
                self.transaction.push(data)
            }, false)
        }
    })
</script>
</body>

</html>
